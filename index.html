<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>It’s 5 O’Clock Somewhere</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; height: 100%; }
    #map { height: 100%; }
    .info {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 8px;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0,0,0,0.2);
      font-family: sans-serif;
      max-width: 250px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info" id="info">Loading...</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  // Create map with attribution control enabled
  var map = L.map('map', {
    attributionControl: true
  }).setView([20, 0], 2);

  // Remove default "Leaflet" attribution text
  map.attributionControl.setPrefix(false);

  // Add OSM tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    // don't need default attribution since you're replacing it
  }).addTo(map);

  // GeoJSON of world timezones
  const TZ_GEOJSON = "combined-with-oceans-now.json";
  const infoBox = document.getElementById("info");
  let tzLayer;

  // Map bounds
  const bounds = [
    [-90, -210],
    [90, 210]
  ];
  map.setMaxBounds(bounds);
  map.setMinZoom(2);

  // Check if current hour in a timezone is 5 PM
  function isFiveOClock(tz) {
    try {
      const parts = new Intl.DateTimeFormat("en-US", {
        hour: "2-digit", hour12: false,
        timeZone: tz
      }).formatToParts(new Date());
      const hour = Number(parts.find(p => p.type === "hour")?.value || 0);
      return hour === 17;
    } catch (e) {
      return false;
    }
  }

  // Update map highlights
  function updateLayer(data) {
    if (tzLayer) {
      map.removeLayer(tzLayer);
    }

    tzLayer = L.geoJSON(data, {
      style: f => ({
        color: "#555",
        weight: 0.5,
        fillColor: isFiveOClock(f.properties.tzid) ? "orange" : "transparent",
        fillOpacity: isFiveOClock(f.properties.tzid) ? 0.6 : 0
      }),
      onEachFeature: (f, l) => {
        if (isFiveOClock(f.properties.tzid)) {
          l.bindPopup(`<b>${f.properties.tzid}</b><br>It’s 5 o’clock somewhere!`);
        }
      }
    }).addTo(map);

    const fiveZones = data.features.filter(f => isFiveOClock(f.properties.tzid));
    if (fiveZones.length) {
      infoBox.innerHTML = "It’s 5 o’clock in:<br>" + fiveZones.map(f => f.properties.tzid).join("<br>");
    } else {
      infoBox.innerHTML = "No places are in the 5 PM hour right now (wait a sec).";
    }
  }

  // Load GeoJSON once
  fetch(TZ_GEOJSON).then(r => r.json()).then(data => {
    updateLayer(data);
    setInterval(() => updateLayer(data), 60000);
  });

  // Custom attribution text
  map.attributionControl.addAttribution(
    `<a href="https://transfem-emilia.pages.dev/" target="_blank">Emilia Selene</a> | 
     Map Powered By <a href="https://leafletjs.com/" target="_blank">Leaflet JS</a> 
     and <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a>`
  );
</script>

</body>
</html>
